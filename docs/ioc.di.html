<!DOCTYPE html>

<html>
<head>
  <title>ioc.di.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="bus.html">
                  bus.js
                </a>
              
                
                <a class="source" href="extensions.html">
                  extensions.js
                </a>
              
                
                <a class="source" href="storage.html">
                  storage.js
                </a>
              
                
                <a class="source" href="dot.html">
                  dot.js
                </a>
              
                
                <a class="source" href="ioc.test.html">
                  ioc.test.js
                </a>
              
                
                <a class="source" href="ioc.async.html">
                  ioc.async.js
                </a>
              
                
                <a class="source" href="ioc.core.html">
                  ioc.core.js
                </a>
              
                
                <a class="source" href="ioc.di.html">
                  ioc.di.js
                </a>
              
                
                <a class="source" href="ioc.loader.html">
                  ioc.loader.js
                </a>
              
                
                <a class="source" href="ioc.object.html">
                  ioc.object.js
                </a>
              
                
                <a class="source" href="ioc.url.html">
                  ioc.url.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>ioc.di.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*global IOC:true*/</span>
<span class="hljs-comment">/*jshint evil:true*/</span>
IOC.DI = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(ioc)</span> </span>{

  <span class="hljs-keyword">var</span> registry = {};
  <span class="hljs-keyword">var</span> factories = {};

  <span class="hljs-keyword">var</span> _resolveArgs = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(args)</span> </span>{
    <span class="hljs-keyword">var</span> failure = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> resolved = [];
    args.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arg)</span> </span>{
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> arg.value !== <span class="hljs-string">'undefined'</span>) {
        resolved.push(arg.value);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> arg.ref !== <span class="hljs-string">'undefined'</span>) {
        <span class="hljs-keyword">var</span> ref = _getInstance(arg.ref);
        <span class="hljs-keyword">if</span> (ref) {
          resolved.push(ref);
        } <span class="hljs-keyword">else</span> {
          failure = <span class="hljs-literal">true</span>;
        }
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> arg.func !== <span class="hljs-string">'undefined'</span>) {
        resolved.push(arg.func);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> arg.exec !== <span class="hljs-string">'undefined'</span>) {
        resolved.push(arg.exec());
      }
    });
    <span class="hljs-keyword">return</span> failure ? <span class="hljs-literal">null</span> : resolved;
  };

  <span class="hljs-keyword">var</span> _execFunction = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(instance, func, args)</span> </span>{
    <span class="hljs-keyword">var</span> resolvedFunc = (<span class="hljs-keyword">typeof</span> func === <span class="hljs-string">'function'</span> ? func : ioc.object.get(_getInstance(instance), func));
    <span class="hljs-keyword">if</span> (resolvedFunc) {
      <span class="hljs-keyword">var</span> resolvedArgs = _resolveArgs(args || []);
      <span class="hljs-keyword">if</span> (resolvedArgs) {
        resolvedFunc.apply(resolvedFunc, resolvedArgs);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-string">'Unable to resolve arguments for "'</span> + func + <span class="hljs-string">'" of instance "'</span> + instance + <span class="hljs-string">'"'</span>;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'Unknown function "'</span> + func + <span class="hljs-string">'" for instance "'</span> + instance + <span class="hljs-string">'"'</span>;
    }
  };

  <span class="hljs-keyword">var</span> _addInstance = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, instance, factory, args)</span> </span>{
    registry[name] = instance;
    <span class="hljs-keyword">if</span> (factory) {
      factories[name] = args || [];
    }
  };

  <span class="hljs-keyword">var</span> _getInstance = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name)</span> </span>{
    <span class="hljs-keyword">if</span> (factories.hasOwnProperty(name)) {
      <span class="hljs-keyword">var</span> args = _resolveArgs(factories[name] || []);
      <span class="hljs-keyword">if</span> (args) {
        <span class="hljs-keyword">return</span> registry[name].apply(registry[name], args);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-string">'Unable to resolve arguments for "'</span> + name + <span class="hljs-string">'"'</span>;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> registry[name];
    }
  };

  <span class="hljs-keyword">var</span> _wire = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(instances)</span> </span>{
    <span class="hljs-keyword">if</span> (!instances) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">var</span> instanceKeys = ioc.object.keys(instances);
    <span class="hljs-keyword">var</span> unresolved = {};

    instanceKeys.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(instance)</span> </span>{
      <span class="hljs-keyword">var</span> func = ioc.object.get(<span class="hljs-built_in">window</span>, instances[instance].namespace);
      <span class="hljs-keyword">if</span> (func) {
        <span class="hljs-keyword">var</span> args = _resolveArgs(instances[instance].args || []);
        <span class="hljs-keyword">if</span> (args) {
          <span class="hljs-built_in">window</span>.console.log(instance, <span class="hljs-string">'wired'</span>);
          <span class="hljs-keyword">var</span> actualInstance = instances[instance].factory ? func : func.apply(func, args);
          _addInstance(instance, actualInstance, instances[instance].factory, instances[instance].args || []);
          <span class="hljs-keyword">if</span> (instances[instance].extension) {
            ioc = ioc.object.extend(ioc, actualInstance);
          }
        } <span class="hljs-keyword">else</span> {
          unresolved[instance] = instances[instance];
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-string">'Unknown function "'</span> + instances[instance].namespace + <span class="hljs-string">'"'</span>;
      }
    });

    <span class="hljs-keyword">var</span> unresolvedKeys = ioc.object.keys(unresolved);
    <span class="hljs-keyword">if</span> (unresolvedKeys.length !== ioc.object.keys(instances).length &amp;&amp; unresolvedKeys.length &gt; <span class="hljs-number">0</span>) {
      _wire(unresolved);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (unresolvedKeys.length !== <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-string">'Make sure you don\'t have circular dependencies, Unable to resolve the following instances: '</span> + unresolvedKeys.join(<span class="hljs-string">", "</span>);
      }
    }
  };

  <span class="hljs-keyword">var</span> _init = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(instances)</span> </span>{
    ioc.object.keys(instances).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(instance)</span> </span>{
      <span class="hljs-keyword">if</span> (instances[instance].init) {
        _execFunction(instance, instances[instance].init.func, instances[instance].init.args);
      }
    });
  };

  <span class="hljs-keyword">var</span> _start = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(starts)</span> </span>{
    <span class="hljs-keyword">if</span> (!starts) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">document</span>.readyState !== <span class="hljs-string">'complete'</span>) {
      <span class="hljs-built_in">window</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        _start(starts);
      }, <span class="hljs-number">100</span>);
    } <span class="hljs-keyword">else</span> {
      starts.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(start)</span> </span>{
        <span class="hljs-keyword">if</span> (start.instance) {
          _execFunction(start.instance, start.func, start.args);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (start.func) {
          _execFunction(<span class="hljs-literal">null</span>, start.func, start.args);
        }
      });
    }
  };

  <span class="hljs-keyword">var</span> _loadContext = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (ioc.config.context) {
      <span class="hljs-built_in">window</span>.console.log(<span class="hljs-string">'wire instances'</span>);
      _wire(ioc.config.context.instances);
      <span class="hljs-built_in">window</span>.console.log(<span class="hljs-string">'init instances'</span>);
      _init(ioc.config.context.instances);
      <span class="hljs-built_in">window</span>.console.log(<span class="hljs-string">'start instances'</span>);
      _start(ioc.config.context.start);
    }
  };

  <span class="hljs-keyword">var</span> _loadAsyncDependencies = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(dependencies)</span> </span>{
    <span class="hljs-keyword">var</span> latch = ioc.async.latch(dependencies.async ? dependencies.async.length : <span class="hljs-number">0</span>, _loadContext, <span class="hljs-string">'dependencies'</span>);
    dependencies.async.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(dep)</span> </span>{
      ioc.loader.loadScript(dep, latch.countDown);
    });
  };

  <span class="hljs-keyword">var</span> _loadSyncDependencies = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (!ioc.config.context || !ioc.config.context.dependencies) {
      <span class="hljs-keyword">return</span> _loadContext();
    }

    <span class="hljs-keyword">var</span> dependencies;
    <span class="hljs-keyword">if</span> (!ioc.config.context.dependencies[ioc.config.mode]) {
      dependencies = {sync: [], async: []};
    } <span class="hljs-keyword">else</span> {
      dependencies = ioc.config.context.dependencies[ioc.config.mode];
    }

    <span class="hljs-keyword">var</span> seqLatch = ioc.async.seqLatch(dependencies.sync || [], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(url)</span> </span>{
      ioc.loader.loadScript(url, seqLatch.next);
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      _loadAsyncDependencies(dependencies);
    });
    seqLatch.next();
  };

  <span class="hljs-keyword">var</span> _mergeImports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(imports)</span> </span>{
    <span class="hljs-keyword">var</span> imp = imports.pop();
    <span class="hljs-keyword">var</span> unloadedImports = [];

    <span class="hljs-keyword">while</span> (imp) {
      <span class="hljs-keyword">if</span> (!ioc.object.get(<span class="hljs-built_in">window</span>, imp.namespace)) {
        unloadedImports.push(imp);
      } <span class="hljs-keyword">else</span> {
        ioc.config = ioc.object.extend(ioc.config, ioc.object.get(<span class="hljs-built_in">window</span>, imp.namespace)());
      }
      imp = imports.pop();
    }

    <span class="hljs-keyword">if</span> (unloadedImports.length !== <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">var</span> latch = ioc.async.latch(unloadedImports.length, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        _mergeImports(unloadedImports);
      }, <span class="hljs-string">'imports'</span>);
      unloadedImports.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(subImp)</span> </span>{
        ioc.loader.loadScript(subImp.url, latch.countDown);
      });
    } <span class="hljs-keyword">else</span> {
      _loadSyncDependencies();
    }
  };

  <span class="hljs-keyword">var</span> _loadConfig = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(config)</span> </span>{
    _addInstance(<span class="hljs-string">'ioc'</span>, ioc);
    ioc.config = config;
    ioc.config.mode = ioc.url.query().env || <span class="hljs-string">'default'</span>;
    <span class="hljs-built_in">window</span>.console.log(<span class="hljs-string">'IOC: Starting in mode'</span>, ioc.config.mode);
    <span class="hljs-keyword">if</span> (config.exposeIoc) {
      <span class="hljs-built_in">window</span>.ioc = ioc;
    }

    <span class="hljs-keyword">if</span> (ioc.config.imports) {
      _mergeImports(<span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">JSON</span>.stringify(ioc.config.imports)));
    } <span class="hljs-keyword">else</span> {
      _loadSyncDependencies();
    }
  };

  <span class="hljs-keyword">var</span> _processAnnotations = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(text)</span> </span>{
    <span class="hljs-keyword">var</span> regex = <span class="hljs-regexp">/@ioc-instance\s+["']([^"']+)["']\s*(.*);\s*(@ioc-init\s+["']([^"']+)["']\s*(.*);)*\s*(@ioc-start\s+["']([^"']+)["']\s*(.*);)*\s*\*\/\s*([\w.]+)/g</span>;
    <span class="hljs-keyword">var</span> match;
    <span class="hljs-keyword">while</span> ((match = regex.exec(text))) {
      _processAnnotation(match);
    }
  };

  <span class="hljs-keyword">var</span> _processArgAnnotation = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(match)</span> </span>{
    <span class="hljs-keyword">var</span> args = [];
    <span class="hljs-keyword">var</span> split = match.split(<span class="hljs-string">','</span>);
    split.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arg)</span> </span>{
      <span class="hljs-keyword">var</span> argPair = arg.split(<span class="hljs-string">":"</span>);
      <span class="hljs-keyword">var</span> argObj = {};
      argObj[argPair[<span class="hljs-number">0</span>].trim()] = argPair[<span class="hljs-number">0</span>].trim() === <span class="hljs-string">'ref'</span> ? argPair[<span class="hljs-number">1</span>].trim() : <span class="hljs-built_in">eval</span>(argPair[<span class="hljs-number">1</span>].trim());
      args.push(argObj);
    });
    <span class="hljs-keyword">return</span> args;
  };

  <span class="hljs-keyword">var</span> _processAnnotation = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(match)</span> </span>{
    <span class="hljs-keyword">var</span> instanceName = match[<span class="hljs-number">1</span>];
    <span class="hljs-keyword">var</span> namespace = match[<span class="hljs-number">9</span>];

    <span class="hljs-keyword">if</span> (!instanceName) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (!ioc.config.context) {
      ioc.config.context = {instances: {}};
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ioc.config.context.instances[instanceName] = {namespace: namespace};
    <span class="hljs-keyword">if</span> (match[<span class="hljs-number">2</span>]) {
      ioc.config.context.instances[instanceName].args = _processArgAnnotation(match[<span class="hljs-number">2</span>]);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>init</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (match[<span class="hljs-number">4</span>]) {
      ioc.config.context.instances[instanceName].init = {func: match[<span class="hljs-number">4</span>]};
      <span class="hljs-keyword">if</span> (match[<span class="hljs-number">5</span>]) {
        ioc.config.context.instances[instanceName].init.args = _processArgAnnotation(match[<span class="hljs-number">5</span>]);
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>start</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (match[<span class="hljs-number">7</span>]) {
      <span class="hljs-keyword">var</span> start = {instance: instanceName, func: match[<span class="hljs-number">7</span>]};
      <span class="hljs-keyword">if</span> (match[<span class="hljs-number">8</span>]) {
        start.args = _processArgAnnotation(match[<span class="hljs-number">8</span>]);
      }
      <span class="hljs-keyword">if</span> (!ioc.config.context.start) {
        ioc.config.context.start = [];
      }
      ioc.config.context.start.push(start);
    }
  };

  <span class="hljs-keyword">return</span> {
    di: {
      loadConfig: _loadConfig,
      getInstance: _getInstance,
      addInstance: _addInstance,
      processAnnotations: _processAnnotations
    }
  };
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
